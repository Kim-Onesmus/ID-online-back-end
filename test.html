<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Access Example</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();"
        crossorigin="anonymous"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #video-container {
            position: relative;
        }

        #video {
            width: 300px;
            height: 200px;
        }

        #captureButton {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>

<body>

    <div id="video-container">
        <video id="video" autoplay></video>
        <button id="captureButton" class="btn btn-primary" style="display: none;">Capture and Save</button>
    </div>

    <button id="openCameraButton" class="btn btn-primary">Open Camera</button>
    <canvas id="canvas" width="300px" height="200px" style="display: none;"></canvas>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let openCameraButton = document.getElementById('openCameraButton');
        let captureButton = document.getElementById('captureButton');
        let stream;

        openCameraButton.onclick = function () {
            // Check if the browser supports the getUserMedia API
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Request access to the camera
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (streamObj) {
                        // The user granted access to the camera
                        // You can now use the stream to display the camera feed, capture images, etc.
                        stream = streamObj;
                        video.srcObject = streamObj;
                        captureButton.style.display = 'block';
                        openCameraButton.style.display = 'none';

                        // Set up canvas for image capture
                        const context = canvas.getContext('2d');

                        // Capture and save image
                        captureButton.onclick = function () {
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // Convert canvas image data to base64
                            const imageData = canvas.toDataURL('image/jpeg');

                            // Send base64 image data to Django backend
                            fetch('/save_photo/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}',
                                },
                                body: JSON.stringify({ image_data: imageData }),
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data);
                                    // Optionally, redirect to another page or handle the response
                                })
                                .catch(error => console.error(error));

                            // Stop the camera stream and hide video and canvas
                            stream.getTracks().forEach(track => track.stop());
                            video.style.display = 'none';
                            canvas.style.display = 'none';
                            openCameraButton.style.display = 'block';
                        };
                    })
                    .catch(function (error) {
                        // The user denied access to the camera or an error occurred
                        console.error('Error accessing the camera:', error);
                    });
            } else {
                // The browser does not support the getUserMedia API
                console.error('getUserMedia is not supported in this browser');
            }
        };
    </script>

</body>

</html>