<!-- {% extends 'main.html' %} -->
{% load static %}
{% block content %}

<style>
    #cameraContainer {
        position: relative;
        display: none;
    }

    #video {
        width: 240px;
        height: 280px;
    }

    #capture {
        position: absolute;
        bottom: 10px;
        left: 20%;
        transform: translateX(-50%);
    }
</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            Apply ID
            <small></small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">Apply ID</li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-md-3">
                <!-- general form elements -->
                <div class="">
                    <!-- form start -->
                    <form role="form">
                        <div class="box-body">
                            <div style="text-align: center;" class="form-group">
                                <!-- <img style="width: 200px; height: 200px; border-radius: 50%;"
                                            src="dist/img/user2-160x160.jpg" class="user-image" /> -->
                            </div>
                        </div><!-- /.box-body -->
                    </form>
                </div><!-- /.box -->
            </div>
            <div class="col-md-5">
                <!-- general form elements disabled -->
                <div class="box box-primary">
                    <div class="box-header text-center danger">
                        <h3 style="color: red;" class="box-title text-bold">Step 4 of 4 <br>
                            <span style="color: dodgerblue;">Take Photo</span>
                        </h3>
                        {% for data in messages %}
                        {{data}}
                        {% endfor %}
                    </div><!-- /.box-header -->
                    <div class="box-body d-flex flex-column align-items-center">
                        <form class="w-50" role="form">
                            <div class="box-body">
                                <div class="form-group col-md-12">
                                    <div id="cameraContainer">
                                        <video id="video" autoplay></video>
                                        <button id="capture">Capture Photo</button>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center;" class="box-footer">
                                <button id="startCamera" class="btn btn-primary">Start Camera</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<div id="cameraContainer">
    <video id="video" autoplay></video>
    <button id="capture">Capture Photo</button>
</div>
<button id="startCamera">Start Camera</button>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const startCameraButton = document.getElementById('startCamera');
        const cameraContainer = document.getElementById('cameraContainer');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        let stream;

        startCameraButton.addEventListener('click', () => {
            // Check for camera support
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(videoStream => {
                        stream = videoStream;
                        video.srcObject = stream;
                        cameraContainer.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error accessing camera:', error);
                    });
            } else {
                console.error('getUserMedia not supported on your browser');
            }
        });

        captureButton.addEventListener('click', () => {
            // Draw the current frame of the video onto the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Extract the image data from the canvas
            const imageData = canvas.toDataURL('image/jpeg');

            // Stop the video stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                cameraContainer.style.display = 'none';
            }

            // Send the image data to the server using an AJAX request
            fetch('/capture_photo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token,
                },
                body: JSON.stringify({ photo: imageData }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Handle the server response as needed
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    });
</script>
{% endblock content %}