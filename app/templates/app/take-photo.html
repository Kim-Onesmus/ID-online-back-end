{% extends 'main.html' %}
{% load static %}
{% block content %}

<script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" crossorigin="anonymous"></script>

<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            Apply ID
            <small></small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">Apply ID</li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-md-3">
                <!-- general form elements -->
                <div class="">
                    <!-- form start -->
                    <form role="form">
                        <div class="box-body">
                            <div style="text-align: center;" class="form-group">
                                <!-- <img style="width: 200px; height: 200px; border-radius: 50%;"
                                            src="dist/img/user2-160x160.jpg" class="user-image" /> -->
                            </div>
                        </div><!-- /.box-body -->
                    </form>
                </div><!-- /.box -->
            </div>
            <div class="col-md-5">
                <!-- general form elements disabled -->
                <div class="box box-primary">
                    <div class="box-header text-center danger">
                        <h3 style="color: red;" class="box-title text-bold">Step 4 of 4 <br>
                            <span style="color: dodgerblue;">Take Photo</span>
                        </h3>
                        {% for data in messages %}
                        {{data}}
                        {% endfor %}
                    </div><!-- /.box-header -->
                    <div class="box-body d-flex flex-column align-items-center">
                        <form class="w-50" role="form">
                            <div class="box-body">
                                <div class="form-group col-md-12">
                                    <video id="video" width="300px" height="200px" autoplay></video>
                                    <button id="captureButton" class="btn btn-primary">Capture and Save</button>
                                    <canvas id="canvas" width="300px" height="200px" style="display: none;"></canvas>
                                </div>
                            </div>

                            <div style="text-align: center;" class="box-footer">
                                <!-- <button id="captureButton" class="btn btn-primary">Capture and Save</button> -->
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let captureButton = document.getElementById('captureButton');

    async function onOpenCvReady() {
        // Initialize camera
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        // Set up canvas for image capture
        const context = canvas.getContext('2d');

        // Capture and save image
        captureButton.onclick = function () {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas image data to base64
            const imageData = canvas.toDataURL('image/jpeg');

            // Send base64 image data to Django backend
            fetch('/save_photo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ image_data: imageData }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Optionally, redirect to another page or handle the response
                })
                .catch(error => console.error(error));
        };
    }
</script>
{% endblock content %}